<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>账户设置 - 论语SDK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/v2/analects.css">
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>
      body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
      h1, h2, h3 { font-family: 'Noto Serif SC', serif; }
      .form-section { background-color: white; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 24px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.03), 0 1px 2px -1px rgba(0, 0, 0, 0.03); }
      .form-section h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f1f5f9; }
      .form-label { display: block; font-weight: 500; margin-bottom: 8px; color: #475569; font-size: 0.875rem; }
      .form-input { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; transition: all 0.2s ease; background-color: white; }
      .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
      .form-input:disabled, .form-input[readonly] { background-color: #f1f5f9; cursor: not-allowed; color: #64748b; }
      .form-submit-btn { padding: 9px 18px; border: none; border-radius: 8px; background-color: #3b82f6; color: white; font-weight: 500; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
      .form-submit-btn:hover { background-color: #2563eb; }
      .form-submit-btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
  </style>
</head>
<body class="page-with-sticky-header text-gray-800 antialiased">

  <header id="global-header-wrapper"></header>

  <div class="container mx-auto max-w-2xl px-4 py-8">
    
    <header class="text-center mb-8 border-b pb-4">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">账户设置</h1>
      <p class="text-lg text-gray-500 mt-2">管理您的个人资料和密码</p>
      <a href="/" class="text-blue-600 hover:underline mt-4 inline-block">&larr; 返回首页</a>
    </header>

    <main id="account-settings-container">
      <section class="form-section">
        <h2 class="text-xl font-semibold mb-4">个人资料</h2>
        <form id="profile-form">
          <div>
            <label for="email" class="form-label">邮箱地址</label>
            <input type="email" id="email" name="email" class="form-input" readonly>
          </div>
        </form>
      </section>

      <section class="form-section">
        <h2 class="text-xl font-semibold mb-4">修改密码</h2>
        <form id="password-form">
          <div>
            <label for="new-password" class="form-label">新密码</label>
            <input type="password" id="new-password" name="new-password" class="form-input" required minlength="6">
            <p id="password-helper-text" class="text-xs text-gray-500 mt-1">至少6位字符，不允许纯数字或者字母。</p>
          </div>
          <div class="mt-4">
            <button type="submit" class="form-submit-btn">更新密码</button>
          </div>
        </form>
      </section>
    </main>
  </div>
  
  <div id="analects-global-widget-container"></div>

  <footer class="mt-10 md:mt-12 pt-10 border-t border-gray-200">
    <div class="text-center text-sm text-gray-500 max-w-3xl mx-auto px-4">
        <p>&copy; <span id="year"></span> 论语SDK. Made with ❤️ by <a href="https://lehua.li" class="text-blue-600 hover:underline">lehua.li</a></p>
    </div>
  </footer>
  
  <script type="module" src="/v2/analects.js"></script>
  <script type="module">
    (async () => {
      // 1. 初始化SDK
      const sdk = new AnalectsSDK({
        supabaseUrl: 'https://btqbtibvevglwcpiewyu.supabase.co',
        supabaseKey: 'sb_publishable_Kl_dygwfqk0Uey1G-0rj3A_4sbCgnet'
      });
      
      sdk.renderGlobalHeader();
      await sdk.init();
      const user = sdk.currentUser;
      const accountContainer = document.getElementById('account-settings-container');

      if (!user) {
        accountContainer.innerHTML = 
          '<div class="text-center text-gray-500 py-8"><p class="text-lg">请先登录以管理您的账户。</p><a href="/" class="text-blue-600 hover:underline mt-4 inline-block">去首页登录</a></div>';
        return;
      }

      // 2. 填充通用信息
      document.getElementById('email').value = user.email;

      // 3. 处理密码修改逻辑
      const passwordForm = document.getElementById('password-form');
      const passwordInput = document.getElementById('new-password');
      const passwordSubmitBtn = passwordForm.querySelector('button[type="submit"]');
      const passwordHelperText = document.getElementById('password-helper-text');
      
      if (user.app_metadata.provider === 'google') {
        passwordInput.disabled = true;
        passwordSubmitBtn.disabled = true;
        passwordHelperText.textContent = '您通过 Google 登录，无需在此设置密码。';
      } else {
        passwordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const originalBtnText = passwordSubmitBtn.textContent;
          passwordSubmitBtn.disabled = true;
          passwordSubmitBtn.textContent = '更新中...';
          const { error } = await sdk.updatePassword(passwordInput.value);
          if (error) {
            alert(`密码更新失败: ${error.message}`);
          } else {
            alert('密码更新成功！');
            passwordForm.reset();
          }
          passwordSubmitBtn.disabled = false;
          passwordSubmitBtn.textContent = originalBtnText;
        });
      }
    })();
  </script>

</body>
</html>