<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>分享管理 - 论语SDK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/v2/analects.css">
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>
      body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
      h1, h2, h3 { font-family: 'Noto Serif SC', serif; }
      .form-section { background-color: white; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 24px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.03), 0 1px 2px -1px rgba(0, 0, 0, 0.03); }
      .form-section h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f1f5f9; }
      .form-label { display: block; font-weight: 500; margin-bottom: 8px; color: #475569; font-size: 0.875rem; }
      .form-input { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; transition: all 0.2s ease; background-color: white; }
      .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
      .form-submit-btn { padding: 9px 18px; border: none; border-radius: 8px; background-color: #3b82f6; color: white; font-weight: 500; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
      .form-submit-btn:hover { background-color: #2563eb; }
      .form-submit-btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
      .delete-btn { background-color: #ef4444; }
      .delete-btn:hover { background-color: #dc2626; }
  </style>
</head>
<body class="page-with-sticky-header text-gray-800 antialiased">

  <header id="global-header-wrapper"></header>

  <div class="container mx-auto max-w-2xl px-4 py-8">
    
    <header class="text-center mb-8 border-b pb-4">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">分享管理</h1>
      <p class="text-lg text-gray-500 mt-2">管理您分享出去的全部笔记</p>
      <a href="/" class="text-blue-600 hover:underline mt-4 inline-block">&larr; 返回首页</a>
    </header>

    <main id="share-management-container">
      <section class="form-section">
        <h2 class="text-xl font-semibold mb-4">分享我的笔记给他人</h2>
        <div>
            <p class="text-xs text-gray-500 mb-2">输入对方的注册邮箱，即可授权对方只读访问您全部的笔记。您可以随时在下方列表收回授权。</p>
            <form id="share-notebook-form" class="flex flex-col sm:flex-row gap-2 items-start">
                <input type="email" id="share-email-input" required placeholder="接收方的注册邮箱" class="form-input flex-grow">
                <button type="submit" id="share-submit-btn" class="form-submit-btn w-full sm:w-auto whitespace-nowrap">确认分享</button>
            </form>
            <div id="share-status-message" class="mt-2 text-sm h-4"></div>
        </div>
        <div class="mt-6">
            <h3 class="font-semibold text-gray-700 mb-3">我的分享列表</h3>
            <div id="shared-with-list-container" class="space-y-3">
                <p class="text-gray-500 text-sm">正在加载列表...</p>
            </div>
        </div>
      </section>
    </main>
  </div>
  
  <div id="analects-global-widget-container"></div>

  <footer class="mt-10 md:mt-12 pt-10 border-t border-gray-200">
    <div class="text-center text-sm text-gray-500 max-w-3xl mx-auto px-4">
        <p>&copy; <span id="year"></span> 论语SDK. Made with ❤️ by <a href="https://lehua.li" class="text-blue-600 hover:underline">lehua.li</a></p>
    </div>
  </footer>
  
  <script type="module" src="/v2/analects.js"></script>
  <script type="module">
    (async () => {
      // 1. 初始化SDK
      const sdk = new AnalectsSDK({
        supabaseUrl: 'https://btqbtibvevglwcpiewyu.supabase.co',
        supabaseKey: 'sb_publishable_Kl_dygwfqk0Uey1G-0rj3A_4sbCgnet'
      });
      
      sdk.renderGlobalHeader();
      await sdk.init();
      const user = sdk.currentUser;
      const container = document.getElementById('share-management-container');

      if (!user) {
        container.innerHTML = 
          '<div class="text-center text-gray-500 py-8"><p class="text-lg">请先登录以管理您的分享。</p><a href="/" class="text-blue-600 hover:underline mt-4 inline-block">去首页登录</a></div>';
        return;
      }

      // 2. 处理笔记分享逻辑
      const shareForm = document.getElementById('share-notebook-form');
      const shareEmailInput = document.getElementById('share-email-input');
      const shareSubmitBtn = document.getElementById('share-submit-btn');
      const shareStatusDiv = document.getElementById('share-status-message');
      const sharedListContainer = document.getElementById('shared-with-list-container');
      
      const renderSharedList = async () => {
        sharedListContainer.innerHTML = '<p class="text-gray-500 text-sm">正在加载列表...</p>';
        const sharedWithList = await sdk.getSharedWithList();
        
        if (sharedWithList.length === 0) {
            sharedListContainer.innerHTML = '<p class="text-gray-500 text-sm">您还没有分享给任何人。</p>';
            return;
        }
        
        sharedListContainer.innerHTML = sharedWithList.map(share => {
          const shareDate = new Date(share.created_at).toLocaleDateString();
          let statusTextHTML = `分享于 ${shareDate} <span class="font-bold text-green-600">(生效中)</span>`;

          if (share.status !== 'active') {
              const revokeDate = new Date(share.updated_at).toLocaleDateString();
              statusTextHTML = `分享于 ${shareDate} / <span class="text-red-600">已收回于 ${revokeDate}</span>`;
          }

          return `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
              <div>
                  <p class="font-medium text-gray-800 text-sm">${sdk.escapeHtml(share.borrower.email)}</p>
                  <p class="text-xs text-gray-500">${statusTextHTML}</p>
              </div>
              ${share.status === 'active' ? `<button class="form-submit-btn delete-btn !text-xs !py-1 !px-3" data-borrower-id="${share.borrower_user_id}">收回</button>` : ''}
          </div>`
        }).join('');
        
        document.querySelectorAll('.delete-btn[data-borrower-id]').forEach(button => {
            button.addEventListener('click', handleRevoke);
        });
      };

      const handleRevoke = async (e) => {
          const borrowerId = e.target.dataset.borrowerId;
          const confirmed = await sdk.showConfirmationModal(
              '确认收回？', 
              '您确定要收回对此用户的笔记分享吗？对方将无法再查看您的笔记。',
              '确认收回'
          );
          if (confirmed) {
              const { error } = await sdk.revokeShare(borrowerId);
              if (error) {
                  alert('操作失败，请重试');
              } else {
                  renderSharedList();
              }
          }
      };
      
      shareForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const originalBtnText = shareSubmitBtn.textContent;
        shareSubmitBtn.disabled = true;
        shareSubmitBtn.textContent = '处理中...';
        shareStatusDiv.textContent = '';
        const result = await sdk.shareNotebook(shareEmailInput.value);
        if (result.success) {
          shareStatusDiv.className = 'text-green-600 mt-2 text-sm';
          shareEmailInput.value = '';
          await renderSharedList();
        } else {
          shareStatusDiv.className = 'text-red-600 mt-2 text-sm';
        }
        shareStatusDiv.textContent = result.message;
        shareSubmitBtn.disabled = false;
        shareSubmitBtn.textContent = originalBtnText;
      });

      renderSharedList();
    })();
  </script>

</body>
</html>